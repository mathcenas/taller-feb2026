---
- name: Reparar Repositorios e Instalar NFS
  hosts: centos
  become: yes
  vars:
    nfs_export_path: "/srv/nfs/shared"

  tasks:
    - name: 1. Verificar conectividad a Internet (Ping a Google)
      command: ping -c 2 8.8.8.8
      register: internet_check
      ignore_errors: yes

    - name: 2. Fallar si no hay internet
      fail:
        msg: "El nodo no tiene salida a internet (ping 8.8.8.8 falló). Revisa el Gateway/NAT."
      when: internet_check.rc != 0

    - name: 3. Intentar reparar repositorios (Reset de DNF)
      shell: |
        rm -rf /var/cache/dnf
        dnf clean all
        dnf makecache
      ignore_errors: yes

    - name: 4. Forzar instalación con log detallado
      shell: dnf install -y nfs-utils rpcbind
      register: dnf_install_cmd
      ignore_errors: yes

    - name: 5. Mostrar error de DNF si falló
      debug:
        var: dnf_install_cmd.stderr_lines
      when: dnf_install_cmd.rc != 0

    - name: 6. Crear directorio (si la instalación tuvo éxito)
      file:
        path: "{{ nfs_export_path }}"
        state: directory
        owner: nobody
        group: nobody
        mode: '0777'

    - name: 7. Configurar /etc/exports
      copy:
        dest: /etc/exports
        content: "{{ nfs_export_path }} *(rw,sync,no_root_squash)"

    - name: 8. Levantar servicios (Solo si el archivo existe ahora)
      shell: |
        systemctl daemon-reload
        systemctl enable rpcbind --now
        systemctl enable nfs-server --now
      when: dnf_install_cmd.rc == 0

    - name: 9. Abrir Firewall
      ansible.posix.firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop: [nfs, mountd, rpc-bind]
      ignore_errors: yes
